#+PROPERTY: header-args :session api :results output :exports both

* API
#+NAME: token
#+BEGIN_SRC shell :session none :results output silent :exports none
  make -s -C .. token
#+END_SRC

#+BEGIN_SRC python :preamble "# -*- coding: utf-8 -*-" :results output silent :var token=token :exports none
  import subprocess
  import http.client
  import json
  
  token = token.strip()
  verbose = True

  def pp(data):
    print(json.dumps(data, indent=2, sort_keys=True))
    
  def silent(fn):
    global verbose
    verbose = False
    res = fn()
    verbose = True
    return res

  def api(method, url, data):
    conn = http.client.HTTPConnection('localhost:4000')
    conn.request(method, url, json.dumps(data) if data else None, {
      'Content-type': 'application/json',
      'Authorization': 'Bearer ' + token
    })
    response = conn.getresponse()
    
    if verbose:
      print("{} {}".format(response.status, response.reason))
    if response.status >= 200 and response.status <= 500:
      data = json.loads(response.read().decode())
      if verbose:
        print()
        print(json.dumps(data, indent=2, sort_keys=True))
      return data

  def GET(url):
    return api('GET', url, None)

  def POST(url, data):
    return api('POST', url, data)
#+END_SRC

#+RESULTS:

** Wallet info
#+BEGIN_SRC python
  _ = GET('/api/wallet')
#+END_SRC

#+RESULTS:
#+begin_example
200 OK

{
  "data": {
    "balance": {
      "msatoshi": 1000000000
    },
    "id": "15bf9699-d13b-4d33-b06b-95202d1f59a1"
  }
}
#+end_example
** Invoice info
#+BEGIN_SRC python
  _ = GET('/api/wallet/invoice/lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq')
#+END_SRC

#+RESULTS:
: 200 OK
: 
: {
:   "data": {
:     "description": "Foobar #ldq",
:     "dst_alias": "SomeNodeAlias #039",
:     "msatoshi": 150000
:   }
: }
** Process transaction (invoice)
#+BEGIN_SRC python
  _ = POST('/api/wallet/transactions', {"invoice": "lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq"})
#+END_SRC

#+RESULTS:
#+begin_example
201 Created

{
  "data": {
    "description": "Foobar #ldq",
    "id": "dc18bb9e-9848-47a2-a4ed-390558946009",
    "inserted_at": "2018-08-28T21:33:39.339356",
    "invoice": "lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq",
    "msatoshi": -150000,
    "processed_at": "2018-08-28T21:33:39.399469",
    "state": "approved"
  }
}
#+end_example
** List transactions
#+BEGIN_SRC python
  _ = GET('/api/wallet/transactions')
#+END_SRC

#+RESULTS:
#+begin_example
200 OK

{
  "data": [
    {
      "description": "Foobar #ldq",
      "id": "dc18bb9e-9848-47a2-a4ed-390558946009",
      "inserted_at": "2018-08-28T21:33:39.339356",
      "invoice": "lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq",
      "msatoshi": -150000,
      "processed_at": "2018-08-28T21:33:39.399469",
      "state": "approved"
    },
    {
      "description": "Funding transaction",
      "id": "ba25d362-3d2e-4166-accc-60ca0fe7e2bd",
      "inserted_at": "2018-08-28T21:33:27.507080",
      "msatoshi": 1000000000,
      "processed_at": null,
      "state": "approved"
    }
  ]
}
#+end_example
** Send Bitcoin to email address
*** Create transaction (payer)
#+BEGIN_SRC python :cache yes
  email_src_trn = POST('/api/wallet/transactions', {
      "to_email": "a@b.cz",
      "msatoshi": 1000,
      "description": "Free BTC",    # optional - visible to both payee & payer
      "expires_after": 900          # in seconds
  })['data']
#+END_SRC

#+RESULTS[add74a74026bf272a0270247a1c37396ad10f1ee]:
#+begin_example
201 Created

{
  "data": {
    "claim_expires_at": "2018-08-28T21:49:05.397935",
    "description": "Free BTC",
    "id": "b9515b26-3948-474e-815d-ffc779755739",
    "inserted_at": "2018-08-28T21:34:05.398011",
    "msatoshi": -1000,
    "processed_at": null,
    "state": "initial"
  }
}
#+end_example

**** With amount exceeding wallet balance
It returns declined transaction.

#+BEGIN_SRC python
  wallet = silent(lambda: GET('/api/wallet'))
  _ = POST('/api/wallet/transactions', {
      "to_email": "a@b.cz",
      "msatoshi": wallet['data']['balance']['msatoshi'] + 1,
      "description": "Free BTC",
      "expires_after": 900
  })
#+END_SRC

#+RESULTS:
#+begin_example
201 Created

{
  "data": {
    "claim_expires_at": "2018-08-28T21:49:28.802290",
    "description": "Free BTC",
    "id": "dc8dcff8-8a84-4d0b-a3d3-ff21618ef86a",
    "inserted_at": "2018-08-28T21:34:28.802358",
    "msatoshi": -999849001,
    "processed_at": "2018-08-28T21:34:28.809444",
    "state": "declined"
  }
}
#+end_example

**** With invalid amount
#+BEGIN_SRC python
  _ = POST('/api/wallet/transactions', {
      "to_email": "a@b.cz",
      "msatoshi": -1000, # <- can't send negative amount
      "description": "Free BTC",
      "expires_after": 900
  })
#+END_SRC

#+RESULTS:
: 400 Bad Request
: 
: {
:   "error": {
:     "detail": "Non-positive amount given"
:   }
: }

*** Claim transaction (payee)
**** Success
#+BEGIN_SRC python :cache yes
  _ = POST('/api/wallet/transactions', {"claim_token": "e49511d0-4374-4e0f-9400-fa30bf8c34d8"})
#+END_SRC

#+RESULTS[9f1ba8d17731df90597f47c61f8c69a8bb20111c]:
#+begin_example
201 Created

{
  "data": {
    "description": "Free BTC",
    "id": "980ce198-f97f-45b9-8d78-b7ae7a9fe117",
    "inserted_at": "2018-08-28T21:34:55.285028",
    "msatoshi": 1000,
    "processed_at": "2018-08-28T21:34:55.284941",
    "state": "approved"
  }
}
#+end_example

***** Call is idempotent
#+BEGIN_SRC python :cache yes
  _ = POST('/api/wallet/transactions', {"claim_token": "e49511d0-4374-4e0f-9400-fa30bf8c34d8"})
  _ = POST('/api/wallet/transactions', {"claim_token": "e49511d0-4374-4e0f-9400-fa30bf8c34d8"})
#+END_SRC

#+RESULTS[d231476f41de0d34770ad77906cd081a6afb0393]:
#+begin_example
201 Created

{
  "data": {
    "description": "Free BTC",
    "id": "980ce198-f97f-45b9-8d78-b7ae7a9fe117",
    "inserted_at": "2018-08-28T21:34:55.285028",
    "msatoshi": 1000,
    "processed_at": "2018-08-28T21:34:55.284941",
    "state": "approved"
  }
}
201 Created

{
  "data": {
    "description": "Free BTC",
    "id": "980ce198-f97f-45b9-8d78-b7ae7a9fe117",
    "inserted_at": "2018-08-28T21:34:55.285028",
    "msatoshi": 1000,
    "processed_at": "2018-08-28T21:34:55.284941",
    "state": "approved"
  }
}
#+end_example

**** Failure: Expired
#+BEGIN_SRC python :cache yes
  email_expired_src_trn = silent(lambda: POST('/api/wallet/transactions', {
      "to_email": "a@b.cz",
      "msatoshi": 1000,
      "description": "Free BTC",
      "expires_after": 0          # already expired
  }))['data']
#+END_SRC

#+RESULTS[b463bddae0f43638809d5729731e7775931b62d5]:

#+BEGIN_SRC python :cache yes
  _ = POST('/api/wallet/transactions', {"claim_token": "abfb0e24-9719-4eec-b0c1-07fd4e11f9a6"})
#+END_SRC

#+RESULTS[c6c9470f5d3b1d56585ac63c3f514ee9e20415f4]:
: 400 Bad Request
: 
: {
:   "error": {
:     "detail": "Non-claimable transaction"
:   }
: }

*** Payer sees that transaction has been claimed
- status :: approved
- processed_at :: timestamp of claim event

#+BEGIN_SRC python
  _ = GET('/api/wallet/transactions/' + email_src_trn['id'])
#+END_SRC

#+RESULTS:
#+begin_example
200 OK

{
  "data": {
    "claim_expires_at": "2018-08-28T21:49:05.397935",
    "description": "Free BTC",
    "id": "b9515b26-3948-474e-815d-ffc779755739",
    "inserted_at": "2018-08-28T21:34:05.398011",
    "msatoshi": -1000,
    "processed_at": "2018-08-28T21:34:55.288132",
    "state": "approved"
  }
}
#+end_example

