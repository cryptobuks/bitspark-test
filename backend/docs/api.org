#+PROPERTY: header-args :session api :results output :exports both

#+NAME: token
#+BEGIN_SRC shell :session none :results output silent :exports none
  make -s -C .. token
#+END_SRC
#+BEGIN_SRC python :preamble "# -*- coding: utf-8 -*-" :results output silent :var token=token :exports none
  import subprocess
  import http.client
  import json
  
  token = token.strip()
  verbose = True

  def pp(data):
    print(json.dumps(data, indent=2, sort_keys=True))
    
  def silent(fn):
    global verbose
    verbose = False
    res = fn()
    verbose = True
    return res

  def api(method, url, data):
    conn = http.client.HTTPConnection('localhost:4000')
    conn.request(method, url, json.dumps(data) if data else None, {
      'Content-type': 'application/json',
      'Authorization': 'Bearer ' + token
    })
    response = conn.getresponse()
    
    if verbose:
      print("{} {}".format(response.status, response.reason))
    if response.status >= 200 and response.status <= 500:
      data = json.loads(response.read().decode())
      if verbose:
        print()
        print(json.dumps(data, indent=2, sort_keys=True))
      return data

  def GET(url):
    return api('GET', url, None)

  def POST(url, data):
    return api('POST', url, data)
#+END_SRC

* Wallet info
#+BEGIN_SRC python
  _ = GET('/api/wallet')
#+END_SRC

#+RESULTS:
#+begin_example
200 OK

{
  "data": {
    "balance": {
      "msatoshi": 1000000000
    },
    "id": "f5ae407f-3600-4c9f-a297-76a406c7f80b"
  }
}
#+end_example
* Invoice info
#+BEGIN_SRC python
  _ = GET('/api/wallet/invoice/lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq')
#+END_SRC

#+RESULTS:
: 200 OK
: 
: {
:   "data": {
:     "description": "Foobar #ldq",
:     "dst_alias": "SomeNodeAlias #039",
:     "msatoshi": 150000
:   }
: }
* Process transaction (invoice)
#+BEGIN_SRC python
  _ = POST('/api/wallet/transactions', {"invoice": "lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq"})
#+END_SRC

#+RESULTS:
#+begin_example
201 Created

{
  "data": {
    "description": "Foobar #ldq",
    "id": "1f986192-6493-4fbd-83f2-2dc75ca745fd",
    "inserted_at": "2018-08-30T17:56:37.589777",
    "invoice": "lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq",
    "msatoshi": -150000,
    "processed_at": "2018-08-30T17:56:37.651368",
    "state": "approved"
  }
}
#+end_example
* List transactions
#+BEGIN_SRC python
  _ = GET('/api/wallet/transactions')
#+END_SRC

#+RESULTS:
#+begin_example
200 OK

{
  "data": [
    {
      "description": "Foobar #ldq",
      "id": "1f986192-6493-4fbd-83f2-2dc75ca745fd",
      "inserted_at": "2018-08-30T17:56:37.589777",
      "invoice": "lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq",
      "msatoshi": -150000,
      "processed_at": "2018-08-30T17:56:37.651368",
      "state": "approved"
    },
    {
      "description": "Funding transaction",
      "id": "c569e7e1-7cf8-4bab-9db4-0b4ef1319c00",
      "inserted_at": "2018-08-30T17:56:12.491531",
      "msatoshi": 1000000000,
      "processed_at": null,
      "state": "approved"
    }
  ]
}
#+end_example
* Send Bitcoin to email address
** Create transaction (payer)
#+BEGIN_SRC python :cache yes
  email_src_trn = POST('/api/wallet/transactions', {
      "to_email": "to@example.com",
      "msatoshi": 1000,
      "description": "Free BTC",    # optional - visible to both payee & payer
      "expires_after": 900          # in seconds
  })['data']
#+END_SRC

#+RESULTS[98ca104282dcf30badcfde829dd28ac668bdb6e8]:
#+begin_example
201 Created

{
  "data": {
    "claim_expires_at": "2018-08-30T18:11:50.486755",
    "description": "Free BTC",
    "id": "932deaaf-5969-4654-a8da-f9d43791721b",
    "inserted_at": "2018-08-30T17:56:50.486867",
    "msatoshi": -1000,
    "processed_at": null,
    "state": "initial",
    "to_email": "to@example.com"
  }
}
#+end_example

*** With amount exceeding wallet balance
It returns declined transaction.

#+BEGIN_SRC python
  wallet = silent(lambda: GET('/api/wallet'))
  _ = POST('/api/wallet/transactions', {
      "to_email": "a@b.cz",
      "msatoshi": wallet['data']['balance']['msatoshi'] + 1,
      "description": "Free BTC",
      "expires_after": 900
  })
#+END_SRC

#+RESULTS:
#+begin_example
201 Created

{
  "data": {
    "claim_expires_at": "2018-08-30T18:12:02.069414",
    "description": "Free BTC",
    "id": "a71c7d42-1018-45ae-b493-a9d136fefa0c",
    "inserted_at": "2018-08-30T17:57:02.069524",
    "msatoshi": -999849001,
    "processed_at": "2018-08-30T17:57:02.078259",
    "state": "declined",
    "to_email": "a@b.cz"
  }
}
#+end_example

*** With invalid amount
#+BEGIN_SRC python
  _ = POST('/api/wallet/transactions', {
      "to_email": "a@b.cz",
      "msatoshi": -1000, # <- can't send negative amount
      "description": "Free BTC",
      "expires_after": 900
  })
#+END_SRC

#+RESULTS:
: 400 Bad Request
: 
: {
:   "error": {
:     "detail": "Non-positive amount given"
:   }
: }

** Claim transaction (payee)
*** Success
#+BEGIN_SRC python :cache yes
  _ = POST('/api/wallet/transactions', {"claim_token": "ebd5eef4-61c3-4fd9-87de-6ad7d719f131"})
#+END_SRC

#+RESULTS[eb2b319aacd43456490c8c375806479933dbb4a9]:
#+begin_example
201 Created

{
  "data": {
    "description": "Free BTC",
    "id": "093a5c23-e637-4720-a69c-b1d43cabe83c",
    "inserted_at": "2018-08-30T17:57:33.676110",
    "msatoshi": 1000,
    "processed_at": "2018-08-30T17:57:33.676014",
    "state": "approved"
  }
}
#+end_example

When called multiple times it returns same transaction (i.e. it's idempotent).

#+BEGIN_SRC python :cache yes
  _ = POST('/api/wallet/transactions', {"claim_token": "ebd5eef4-61c3-4fd9-87de-6ad7d719f131"})
  _ = POST('/api/wallet/transactions', {"claim_token": "ebd5eef4-61c3-4fd9-87de-6ad7d719f131"})
#+END_SRC

#+RESULTS[efffb2068e6dbfc3b749e67e8fd000c88b192cf3]:
#+begin_example
201 Created

{
  "data": {
    "description": "Free BTC",
    "id": "093a5c23-e637-4720-a69c-b1d43cabe83c",
    "inserted_at": "2018-08-30T17:57:33.676110",
    "msatoshi": 1000,
    "processed_at": "2018-08-30T17:57:33.676014",
    "state": "approved"
  }
}
201 Created

{
  "data": {
    "description": "Free BTC",
    "id": "093a5c23-e637-4720-a69c-b1d43cabe83c",
    "inserted_at": "2018-08-30T17:57:33.676110",
    "msatoshi": 1000,
    "processed_at": "2018-08-30T17:57:33.676014",
    "state": "approved"
  }
}
#+end_example

*** Failure: Expired
#+BEGIN_SRC python :cache yes
  email_expired_src_trn = silent(lambda: POST('/api/wallet/transactions', {
      "to_email": "to@example.com",
      "msatoshi": 1000,
      "description": "Free BTC",
      "expires_after": 0          # already expired
  }))['data']
#+END_SRC

#+RESULTS[49de308740b101cc401aedfec024e87cf4197e7d]:

#+BEGIN_SRC python :cache yes
  _ = POST('/api/wallet/transactions', {"claim_token": "ae6f77c6-ce90-4f22-9f3d-c239a05634e8"})
#+END_SRC

#+RESULTS[39feceade0eda652e77d73849fbee12dbfa9373f]:
: 400 Bad Request
: 
: {
:   "error": {
:     "detail": "Non-claimable transaction"
:   }
: }

** Payer sees that transaction has been claimed
Status of transaction is =approved= and =processed_at= field marks time of claim event.

#+BEGIN_SRC python
  _ = GET('/api/wallet/transactions/' + email_src_trn['id'])
#+END_SRC

#+RESULTS:
#+begin_example
200 OK

{
  "data": {
    "claim_expires_at": "2018-08-30T18:11:50.486755",
    "description": "Free BTC",
    "id": "932deaaf-5969-4654-a8da-f9d43791721b",
    "inserted_at": "2018-08-30T17:56:50.486867",
    "msatoshi": -1000,
    "processed_at": "2018-08-30T17:57:33.678304",
    "state": "approved",
    "to_email": "to@example.com"
  }
}
#+end_example

