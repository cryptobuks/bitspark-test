Marian Schubert


Table of Contents
─────────────────

1 Wallet info
2 Invoice info
3 Process transaction (invoice)
4 List transactions
5 Send Bitcoin to email address
.. 5.1 Create transaction (payer)
..... 5.1.1 With amount exceeding wallet balance
..... 5.1.2 With invalid amount
.. 5.2 Claim transaction (payee)
..... 5.2.1 Success
..... 5.2.2 Failure: Expired
.. 5.3 Payer sees that transaction has been claimed





1 Wallet info
═════════════

  ┌────
  │ _ = GET('/api/wallet')
  └────

  ┌────
  │ 200 OK
  │ 
  │ {
  │   "data": {
  │     "balance": {
  │       "msatoshi": 1000000000
  │     },
  │     "id": "ba941652-89fb-47fc-b9c0-46cf0640c27a"
  │   }
  │ }
  └────


2 Invoice info
══════════════

  ┌────
  │ _ = GET('/api/wallet/invoice/lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq')
  └────

  ┌────
  │ 200 OK
  │ 
  │ {
  │   "data": {
  │     "description": "Foobar #ldq",
  │     "dst_alias": "SomeNodeAlias #039",
  │     "msatoshi": 150000
  │   }
  │ }
  └────


3 Process transaction (invoice)
═══════════════════════════════

  ┌────
  │ _ = POST('/api/wallet/transactions', {"invoice": "lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq"})
  └────

  ┌────
  │ 201 Created
  │ 
  │ {
  │   "data": {
  │     "description": "Foobar #ldq",
  │     "id": "d2b386a3-b143-495f-975b-cdd1d47d22cc",
  │     "inserted_at": "2018-08-28T21:53:40.752022",
  │     "invoice": "lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq",
  │     "msatoshi": -150000,
  │     "processed_at": "2018-08-28T21:53:40.796472",
  │     "state": "approved"
  │   }
  │ }
  └────


4 List transactions
═══════════════════

  ┌────
  │ _ = GET('/api/wallet/transactions')
  └────

  ┌────
  │ 200 OK
  │ 
  │ {
  │   "data": [
  │     {
  │       "description": "Foobar #ldq",
  │       "id": "d2b386a3-b143-495f-975b-cdd1d47d22cc",
  │       "inserted_at": "2018-08-28T21:53:40.752022",
  │       "invoice": "lntb1500n1pd0c66dpp5p8rpzxck9u7umfl9u7dqratj8rlfthe29xl6ejhwt2exuaxfpftqdqvg9jxgg8zn2sscqzysyv8kgctq7haghaus4wqd262mxr9342mvp23gdsv6vmgkce9zgshjd0av06dq3xpe8cy6fucnj454smkqxuetyvu3h5jggx2w8ethlvcp6g3ldq",
  │       "msatoshi": -150000,
  │       "processed_at": "2018-08-28T21:53:40.796472",
  │       "state": "approved"
  │     },
  │     {
  │       "description": "Funding transaction",
  │       "id": "9ee29ebe-aaf5-4105-844e-85f922c71f10",
  │       "inserted_at": "2018-08-28T21:53:40.522125",
  │       "msatoshi": 1000000000,
  │       "processed_at": null,
  │       "state": "approved"
  │     }
  │   ]
  │ }
  └────


5 Send Bitcoin to email address
═══════════════════════════════

5.1 Create transaction (payer)
──────────────────────────────

  ┌────
  │ email_src_trn = POST('/api/wallet/transactions', {
  │     "to_email": "a@b.cz",
  │     "msatoshi": 1000,
  │     "description": "Free BTC",    # optional - visible to both payee & payer
  │     "expires_after": 900          # in seconds
  │ })['data']
  └────

  ┌────
  │ 201 Created
  │ 
  │ {
  │   "data": {
  │     "claim_expires_at": "2018-08-28T22:07:16.771441",
  │     "description": "Free BTC",
  │     "id": "4d8c598a-474a-40f6-8142-58def5269c0c",
  │     "inserted_at": "2018-08-28T21:52:16.771519",
  │     "msatoshi": -1000,
  │     "processed_at": null,
  │     "state": "initial"
  │   }
  │ }
  └────


5.1.1 With amount exceeding wallet balance
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌

  It returns declined transaction.

  ┌────
  │ wallet = silent(lambda: GET('/api/wallet'))
  │ _ = POST('/api/wallet/transactions', {
  │     "to_email": "a@b.cz",
  │     "msatoshi": wallet['data']['balance']['msatoshi'] + 1,
  │     "description": "Free BTC",
  │     "expires_after": 900
  │ })
  └────

  ┌────
  │ 201 Created
  │ 
  │ {
  │   "data": {
  │     "claim_expires_at": "2018-08-28T22:08:40.973988",
  │     "description": "Free BTC",
  │     "id": "1bc04504-ff00-4e2e-9f93-42ba02e6b81c",
  │     "inserted_at": "2018-08-28T21:53:40.974066",
  │     "msatoshi": -999850001,
  │     "processed_at": "2018-08-28T21:53:40.979580",
  │     "state": "declined"
  │   }
  │ }
  └────


5.1.2 With invalid amount
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌

  ┌────
  │ _ = POST('/api/wallet/transactions', {
  │     "to_email": "a@b.cz",
  │     "msatoshi": -1000, # <- can't send negative amount
  │     "description": "Free BTC",
  │     "expires_after": 900
  │ })
  └────

  ┌────
  │ 400 Bad Request
  │ 
  │ {
  │   "error": {
  │     "detail": "Non-positive amount given"
  │   }
  │ }
  └────


5.2 Claim transaction (payee)
─────────────────────────────

5.2.1 Success
╌╌╌╌╌╌╌╌╌╌╌╌╌

  ┌────
  │ _ = POST('/api/wallet/transactions', {"claim_token": "4470892b-acef-4a9f-8b02-861ceadd6c39"})
  └────

  ┌────
  │ 201 Created
  │ 
  │ {
  │   "data": {
  │     "description": "Free BTC",
  │     "id": "ab619809-5a0a-48b5-bf01-5ac53c4f5b2c",
  │     "inserted_at": "2018-08-28T21:52:48.713919",
  │     "msatoshi": 1000,
  │     "processed_at": "2018-08-28T21:52:48.713790",
  │     "state": "approved"
  │   }
  │ }
  └────


◊ 5.2.1.1 Call is idempotent

  ┌────
  │ _ = POST('/api/wallet/transactions', {"claim_token": "4470892b-acef-4a9f-8b02-861ceadd6c39"})
  │ _ = POST('/api/wallet/transactions', {"claim_token": "4470892b-acef-4a9f-8b02-861ceadd6c39"})
  └────

  ┌────
  │ 201 Created
  │ 
  │ {
  │   "data": {
  │     "description": "Free BTC",
  │     "id": "ab619809-5a0a-48b5-bf01-5ac53c4f5b2c",
  │     "inserted_at": "2018-08-28T21:52:48.713919",
  │     "msatoshi": 1000,
  │     "processed_at": "2018-08-28T21:52:48.713790",
  │     "state": "approved"
  │   }
  │ }
  │ 201 Created
  │ 
  │ {
  │   "data": {
  │     "description": "Free BTC",
  │     "id": "ab619809-5a0a-48b5-bf01-5ac53c4f5b2c",
  │     "inserted_at": "2018-08-28T21:52:48.713919",
  │     "msatoshi": 1000,
  │     "processed_at": "2018-08-28T21:52:48.713790",
  │     "state": "approved"
  │   }
  │ }
  └────


5.2.2 Failure: Expired
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌

  ┌────
  │ email_expired_src_trn = silent(lambda: POST('/api/wallet/transactions', {
  │     "to_email": "a@b.cz",
  │     "msatoshi": 1000,
  │     "description": "Free BTC",
  │     "expires_after": 0          # already expired
  │ }))['data']
  └────

  ┌────
  │ _ = POST('/api/wallet/transactions', {"claim_token": "84507a20-852c-49c5-a2cb-1740766bdbb2"})
  └────

  ┌────
  │ 400 Bad Request
  │ 
  │ {
  │   "error": {
  │     "detail": "Non-claimable transaction"
  │   }
  │ }
  └────


5.3 Payer sees that transaction has been claimed
────────────────────────────────────────────────

  status
        approved
  processed_at
        timestamp of claim event

  ┌────
  │ _ = GET('/api/wallet/transactions/' + email_src_trn['id'])
  └────

  ┌────
  │ 200 OK
  │ 
  │ {
  │   "data": {
  │     "claim_expires_at": "2018-08-28T22:07:16.771441",
  │     "description": "Free BTC",
  │     "id": "4d8c598a-474a-40f6-8142-58def5269c0c",
  │     "inserted_at": "2018-08-28T21:52:16.771519",
  │     "msatoshi": -1000,
  │     "processed_at": "2018-08-28T21:52:48.716889",
  │     "state": "approved"
  │   }
  │ }
  └────
